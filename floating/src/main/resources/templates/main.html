<!DOCTYPE>
<html xml:th="https://www.thymeleaf.org/">
<head>
    <meta charset="UTF-8">
    <title>ë¶€ìœ ë¬¼íƒì§€</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <link th:href="@{/css/Main.css}" rel="stylesheet">
</head>
<body>
<div>
    <nav class="navbar">

        <div class="navbar__logo">
            <i class="fas fa-blog"></i>
            <a th:href="@{/}">íƒì§€ì²´ê³„</a>
        </div>

        <ul class="navbar__menu">
            <li><a href="#">ë¡œê·¸ì¸</a></li>
            <li><a href="#">ê³µì§€ì‚¬í•­</a></li>
            <li><a href="#">ê³ ê°ì„¼í„°</a></li>
        </ul>

    </nav>
</div>
<div class="Mainwrap">

    <section class="mainlogwrap">
       <form method="post" type="multipart/form/data" id="fileUploadForm">
           <input type="text" name="message" id="message_input" value="me" hidden="hidden" />
          <input type="file" name="file" id="file_name">
        <button type="submit" class="btn btn-outline-success" style="min-width: 105px">ë¹„ë™ê¸° ìš”ì²­</button>
       </form>
    </section>
    <div class="MainLog">
        <img id="streamVideo" width="640" />
    </div>
    <section>

    </section>
    <section class="Buttonwrap">
        <a id="Gossip_2" th:href="@{/detection}">íƒì§€ëœ ê°ì²´</a>
        <a id="Picton_2" th:href="@{/dstatistics}">íƒì§€ í†µê³„</a>
    </section>
</div>
<div class="Mainfooter">
    <div class="footrtTop">
        <p>2ì¡°: ë‚´í˜¸ìŠ¹ ì´ë™í¬</p>
    </div>
    <div class="footrtdown">
        <p>@ íƒì§€ì²´ê³„</p>
    </div>
</div>
<script type="text/javascript">
    document.getElementById("fileUploadForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const fileInput = document.getElementById("file_name");
        const messageInput = document.getElementById("message_input");
        const file = fileInput.files[0];

        const button = this.querySelector("button[type=submit]");
        button.disabled = true;

        try {
            const streamElement = document.getElementById("streamVideo");

            if (file.type.startsWith("image/")) {
                const formData = new FormData();
                formData.append("file", file);
                formData.append("message", messageInput.value);

                const res = await fetch("http://localhost:8080/java_service", {
                    method: "POST",
                    body: formData
                });

                const result = await res.json();
                streamElement.src = `data:image/jpeg;base64,${result.image}`;
                streamElement.style.display = "block";
                streamElement.setAttribute("width", "640");

            } else if (file.type.startsWith("video/")) {
                const formData = new FormData();
                formData.append("file", file); // ğŸ¯ messageëŠ” ì œê±°!

                const res = await fetch("http://localhost:8000/upload_stream/", {
                    method: "POST",
                    body: formData
                });

                const responseText = await res.text();

                const img = document.createElement("img");
                img.src = "http://localhost:8000" + responseText;
                img.setAttribute("width", "640");
                img.setAttribute("id", "streamVideo");
                img.setAttribute("alt", "Streaming video");

                streamElement.replaceWith(img);
            }

        } catch (err) {
            console.error("ì—…ë¡œë“œ ì‹¤íŒ¨:", err);
            alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        } finally {
            button.disabled = false;
        }
    });

</script>
</body>
</html>